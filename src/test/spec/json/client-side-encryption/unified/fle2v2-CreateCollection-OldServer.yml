description: fle2v2-CreateCollection-OldServer
schemaVersion: "1.25"
runOnRequirements:
  - minServerVersion: "6.0.0"
    maxServerVersion: "6.3.99"
    # FLE 2 Encrypted collections are not supported on standalone.
    topologies: ["replicaset", "sharded", "load-balanced"]
    csfle:
      minLibmongocryptVersion: "1.15.1"
createEntities:
  - client:
      id: "client0"
      autoEncryptOpts:
        keyVaultNamespace: keyvault.datakeys
        kmsProviders:
          aws: { accessKeyId: { $$placeholder: 1 }, secretAccessKey: { $$placeholder: 1 } }
        encryptedFieldsMap:
          default.encryptedCollection:
            {
              "fields":
                [
                  {
                    "path": "firstName",
                    "bsonType": "string",
                    "keyId": { "$binary": { "base64": "AAAAAAAAAAAAAAAAAAAAAA==", "subType": "04" } },
                  },
                ],
            }
      observeEvents:
        - commandStartedEvent
  - database:
      id: "db"
      client: "client0"
      databaseName: default
  - collection:
      id: "coll"
      database: "db"
      collectionName: default
tests:
  - description: "driver returns an error if creating a QEv2 collection on unsupported server"

    operations:
      # Do an initial drop to remove collections that may exist from previous test runs.
      - name: dropCollection
        object: "db"
        arguments:
          collection: "encryptedCollection"
      - name: createCollection
        object: "db"
        arguments:
          collection: "encryptedCollection"
        expectError:
          errorContains: "Driver support of Queryable Encryption is incompatible with server. Upgrade server to use Queryable Encryption."
      # Assert no collections were created.
      - name: assertCollectionNotExists
        object: testRunner
        arguments:
          databaseName: &database_name "default"
          collectionName: &esc_collection_name "enxcol_.encryptedCollection.esc"
      # ecc collection is no longer created for QEv2
      - name: assertCollectionNotExists
        object: testRunner
        arguments:
          databaseName: *database_name
          collectionName: &ecc_collection_name "enxcol_.encryptedCollection.ecc"
      - name: assertCollectionNotExists
        object: testRunner
        arguments:
          databaseName: *database_name
          collectionName: &ecoc_collection_name "enxcol_.encryptedCollection.ecoc"
      - name: assertCollectionNotExists
        object: testRunner
        arguments:
          databaseName: *database_name
          collectionName: encryptedCollection
