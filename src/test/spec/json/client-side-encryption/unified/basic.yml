description: basic
schemaVersion: "1.25"
runOnRequirements:
  - minServerVersion: "4.1.10"
    csfle:
      minLibmongocryptVersion: "1.15.1"
createEntities:
  - client:
      id: "client0"
      autoEncryptOpts:
        keyVaultNamespace: keyvault.datakeys
        kmsProviders:
          aws: { accessKeyId: { $$placeholder: 1 }, secretAccessKey: { $$placeholder: 1 } }
      observeEvents:
        - commandStartedEvent
  - database:
      id: "db"
      client: "client0"
      databaseName: default
  - collection:
      id: "coll"
      database: "db"
      collectionName: default
  - client:
      id: "client_unencrypted"
      observeEvents:
        - commandStartedEvent
  - database:
      id: "db_unencrypted"
      client: "client_unencrypted"
      databaseName: default
  - collection:
      id: "coll_unencrypted"
      database: "db_unencrypted"
      collectionName: default
initialData:
  - databaseName: default
    collectionName: default
    documents: []
    createOptions:
      validator:
        $jsonSchema:
          {
            "properties":
              {
                "encrypted_w_altname":
                  {
                    "encrypt":
                      {
                        "keyId": "/altname",
                        "bsonType": "string",
                        "algorithm": "AEAD_AES_256_CBC_HMAC_SHA_512-Random",
                      },
                  },
                "encrypted_string":
                  {
                    "encrypt":
                      {
                        "keyId": ["$binary": { "base64": "AAAAAAAAAAAAAAAAAAAAAA==", "subType": "04" }],
                        "bsonType": "string",
                        "algorithm": "AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic",
                      },
                  },
                "random":
                  {
                    "encrypt":
                      {
                        "keyId": ["$binary": { "base64": "AAAAAAAAAAAAAAAAAAAAAA==", "subType": "04" }],
                        "bsonType": "string",
                        "algorithm": "AEAD_AES_256_CBC_HMAC_SHA_512-Random",
                      },
                  },
                "encrypted_string_equivalent":
                  {
                    "encrypt":
                      {
                        "keyId": ["$binary": { "base64": "AAAAAAAAAAAAAAAAAAAAAA==", "subType": "04" }],
                        "bsonType": "string",
                        "algorithm": "AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic",
                      },
                  },
              },
            "bsonType": "object",
          }
  - databaseName: keyvault
    collectionName: datakeys
    documents:
      [
        {
          "status": 1,
          "_id": { "$binary": { "base64": "AAAAAAAAAAAAAAAAAAAAAA==", "subType": "04" } },
          "masterKey":
            {
              "provider": "aws",
              "key": "arn:aws:kms:us-east-1:579766882180:key/89fcc2c4-08b0-4bd9-9f25-e30687b580d0",
              "region": "us-east-1",
            },
          "updateDate": { "$date": { "$numberLong": "1552949630483" } },
          "keyMaterial":
            {
              "$binary":
                {
                  "base64": "AQICAHhQNmWG2CzOm1dq3kWLM+iDUZhEqnhJwH9wZVpuZ94A8gEqnsxXlR51T5EbEVezUqqKAAAAwjCBvwYJKoZIhvcNAQcGoIGxMIGuAgEAMIGoBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDHa4jo6yp0Z18KgbUgIBEIB74sKxWtV8/YHje5lv5THTl0HIbhSwM6EqRlmBiFFatmEWaeMk4tO4xBX65eq670I5TWPSLMzpp8ncGHMmvHqRajNBnmFtbYxN3E3/WjxmdbOOe+OXpnGJPcGsftc7cB2shRfA4lICPnE26+oVNXT6p0Lo20nY5XC7jyCO",
                  "subType": "00",
                },
            },
          "creationDate": { "$date": { "$numberLong": "1552949630483" } },
          "keyAltNames": ["altname", "another_altname"],
        },
      ]
tests:
  - description: "Insert with deterministic encryption, then find it"
    operations:
      - name: insertOne
        arguments:
          document: &doc0 { _id: 1, encrypted_string: "string0" }
        object: "coll"
      - name: find
        arguments:
          filter: { _id: 1 }
        object: "coll"
        expectResult: [*doc0]
    outcome:
      - documents:
          - &doc0_encrypted {
              _id: 1,
              encrypted_string:
                {
                  "$binary":
                    {
                      "base64": "AQAAAAAAAAAAAAAAAAAAAAACwj+3zkv2VM+aTfk60RqhXq6a/77WlLwu/BxXFkL7EppGsju/m8f0x5kBDD3EZTtGALGXlym5jnpZAoSIkswHoA==",
                      "subType": "06",
                    },
                },
            }
        collectionName: &collection_name "default"
        databaseName: &database_name "default"
    expectEvents:
      - client: "client0"
        events:
          # Auto encryption will request the collection info.
          - commandStartedEvent:
              command:
                listCollections: 1
                filter:
                  name: *collection_name
              commandName: listCollections
          - commandStartedEvent:
              command:
                find: datakeys
                filter:
                  {
                    "$or":
                      [
                        "_id": { "$in": ["$binary": { "base64": "AAAAAAAAAAAAAAAAAAAAAA==", "subType": "04" }] },
                        "keyAltNames": { "$in": [] },
                      ],
                  }
                $db: keyvault
                readConcern: { level: "majority" }
              commandName: find
          - commandStartedEvent:
              command:
                insert: *collection_name
                documents:
                  - *doc0_encrypted
                ordered: true
              commandName: insert
          - commandStartedEvent:
              command:
                find: *collection_name
                filter: { _id: 1 }
              commandName: find
  - description: "Insert with randomized encryption, then find it"
    operations:
      - name: insertOne
        arguments:
          document: &doc1 { _id: 1, random: "123" }
        object: "coll"
      - name: find
        arguments:
          filter: { _id: 1 }
        object: "coll"
        expectResult: [*doc1]
      - name: find
        object: coll_unencrypted
        arguments:
          filter: {}
        expectResult:
          - { _id: 1, random: { $$type: "binData" } }
    expectEvents:
      - client: "client0"
        events:
          # Auto encryption will request the collection info.
          - commandStartedEvent:
              command:
                listCollections: 1
                filter:
                  name: *collection_name
              commandName: listCollections
          - commandStartedEvent:
              command:
                find: datakeys
                filter:
                  {
                    "$or":
                      [
                        "_id": { "$in": ["$binary": { "base64": "AAAAAAAAAAAAAAAAAAAAAA==", "subType": "04" }] },
                        "keyAltNames": { "$in": [] },
                      ],
                  }
                $db: keyvault
                readConcern: { level: "majority" }
              commandName: find
          - commandStartedEvent:
              command:
                insert: *collection_name
                documents:
                  - { _id: 1, random: { $$type: "binData" } }
                ordered: true
              commandName: insert
          - commandStartedEvent:
              command:
                find: *collection_name
                filter: { _id: 1 }
              commandName: find
